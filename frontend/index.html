<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Sign In - TodoHouessou</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
    <link rel="shortcut icon" href="favicon.png" >
</head>
<body>
    <div class="container-fluid" style="text-align: center">
        <a class="navbar-brand" href="#">
            <img src="img/logo.png" id="logo" align="center"/>
            <b id="brand-title"></b>
        </a>
    </div>
    <br>
    <div class="container">
        <div class="row">
            <div class="col-md-4 offset-md-4">
                <h2 class="text-center signin-title">Sign In to access your todo-list</h2>
                <form onsubmit="return false;">
                    <div class="form-group input-field">
                        <label for="username">Email</label>
                        <input type="email" class="form-control rounded-0" name="username" id="username"aria-describedby="emailHelp" placeholder="Your email">
                    </div>
                    <div class="form-group input-field">
                        <label for="password">Password</label>
                        <input type="password" class="form-control rounded-0" name="password" id="password" placeholder="Your password">
                    </div>
                    <button class="btn btn-custom signin" onclick="login();">Sign In</button>
                    <div class="login-help">
                        <p>Don't have an account? </p>
                        <a href="register.html">Register!</a>
                      </div>
                </form> 
            </div>
        </div>
    </div>


    <!-- Importing scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="js/amazon-cognito-identity.min.js"></script>
    <script src="js/aws-sdk.min.js"></script>
    <script src="js/script.js"></script>

</body>
<script>
    var todoApiEndpoint = 'https://j3cv37qhud.execute-api.us-east-1.amazonaws.com/dev/';
    var cognitoUserPoolId = 'us-east-1_fM3BzKm1u';
    var cognitoUserPoolClientId = '4ajb6clml9vft00cof689o6c0p';
    var awsRegion = 'us-east-1';

    initializeStorage();

    var configString = localStorage.getItem("awsConfig");
    var config = JSON.parse(configString);
    if(config != null) {
        refreshAWSCredentials();
    }

    function loggedInDisplay() {
        $('#body').css({'visibility':'visible'});
    }


    function initializeStorage() {
      var identityPoolId = cognitoUserPoolId;//
      var userPoolId = cognitoUserPoolId; //
      var clientId = cognitoUserPoolClientId;//
      var loginPrefix = 'cognito-idp.' + awsRegion + '.amazonaws.com/' + identityPoolId;

      localStorage.setItem('identityPoolId', identityPoolId);
      localStorage.setItem('userPoolId', userPoolId);
      localStorage.setItem('clientId', clientId);
      localStorage.setItem('loginPrefix', loginPrefix);
    }

    $("#newTodoForm").submit(function(event) {
      event.preventDefault();
      $('#newTodoModal').modal('toggle')
      var dateDue = document.getElementById('newTodoModalDateDue').value;
      var description = document.getElementById('newTodoModalDescription').value;
      addTodo(dateDue, description );
    });

    function login(){
        var userPoolId = localStorage.getItem('userPoolId');
        var clientId = localStorage.getItem('clientId');
        var identityPoolId = localStorage.getItem('identityPoolId');
        var loginPrefix = localStorage.getItem('loginPrefix');

        var poolData = {
            UserPoolId : userPoolId, // Your user pool id here
            ClientId : clientId // Your client id here
        };
        var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

        var username = $('#username').val();
        var authenticationData = {
            Username: username,
            Password: $('#password').val()
        };

        var authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);

        var userData = {
            Username : username,
            Pool : userPool
        };
        var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

        console.log(cognitoUser);
        cognitoUser.authenticateUser(authenticationDetails, {
            onSuccess: function (result) {
            var accessToken = result.getAccessToken().getJwtToken();
            console.log('Authentication successful', accessToken);
            var sessionTokens =
            {
                IdToken: result.getIdToken(),
                AccessToken: result.getAccessToken(),
                RefreshToken: result.getRefreshToken()
            };
            localStorage.setItem('sessionTokens', JSON.stringify(sessionTokens))
            localStorage.setItem('userID', username);
            window.location = './home.html';
            },

            onFailure: function(err) {
            console.log('failed to authenticate');
            console.log(JSON.stringify(err));
            alert('Failed to Log in.\nPlease check your credentials.');
            },
        });
    }

    function refreshAWSCredentials() {
        var userPoolId = localStorage.getItem('userPoolId');
        var clientId = localStorage.getItem('clientId');
        var identityPoolId = localStorage.getItem('identityPoolId');
        var loginPrefix = localStorage.getItem('loginPrefix');

        var poolData = {
        UserPoolId : userPoolId, // Your user pool id here
        ClientId : clientId // Your client id here
        };
        var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
        var cognitoUser = userPool.getCurrentUser();

        if (cognitoUser != null) {
            cognitoUser.getSession(function(err, result) {
                if (result) {
                    console.log('You are now logged in.');
                    cognitoUser.refreshSession(result.getRefreshToken(), function(err, result) {

                        if (err) {//throw err;
                            console.log('In the err: '+err);
                        }
                        else{
                            localStorage.setItem('awsConfig', JSON.stringify(AWS.config));
                            var sessionTokens =
                            {
                                IdToken: result.getIdToken(),
                                AccessToken: result.getAccessToken(),
                                RefreshToken: result.getRefreshToken()
                            };
                            localStorage.setItem("sessionTokens", JSON.stringify(sessionTokens));

                        }
                    });

                }
            });
        }
    }

    function logOut() {
        localStorage.clear();
        document.location.reload();
        window.location = './index.html';
    }

</script>
</html>